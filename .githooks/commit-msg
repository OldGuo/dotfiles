#!/usr/bin/env python3

import re
import subprocess
import sys
from pathlib import Path


REQUIRED_HEADERS = ("Context:", "Changes:", "Validation:")
PLACEHOLDER_RE = re.compile(r"<type>|<scope>|<summary>|<why>|<what changed>|<tests run>")


def is_merge_commit() -> bool:
    result = subprocess.run(
        ["git", "rev-parse", "-q", "--verify", "MERGE_HEAD"],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        check=False,
    )
    return result.returncode == 0


def fail(message: str) -> None:
    print(message)
    sys.exit(1)


def main() -> None:
    if len(sys.argv) != 2:
        fail("Commit blocked: hook expected commit message file path.")

    msg_file = Path(sys.argv[1])
    raw = msg_file.read_text(encoding="utf-8", errors="replace")

    if is_merge_commit():
        return

    if re.search(r"^(fixup!|squash!) ", raw, re.MULTILINE):
        return

    clean_lines = [
        line for line in raw.splitlines() if not line.lstrip().startswith("#")
    ]
    clean_msg = "\n".join(clean_lines)

    subject = next((line.strip() for line in clean_lines if line.strip()), "")
    if not subject:
        fail("Commit blocked: missing subject line.")

    body_has_content = any(line.strip() for line in clean_lines[1:])
    if not body_has_content:
        fail(
            "Commit blocked: commit body is required.\n\n"
            "Add at least:\n"
            "- Context: why this change is needed\n"
            "- Changes: what was changed\n"
            "- Validation: how it was verified"
        )

    for header in REQUIRED_HEADERS:
        if not re.search(rf"^{re.escape(header)}", clean_msg, re.MULTILINE):
            fail(f"Commit blocked: missing required section '{header}'.")

    if PLACEHOLDER_RE.search(raw):
        fail("Commit blocked: template placeholders are still present.")


if __name__ == "__main__":
    main()
